# 数据库管理指南

## 一、Python 代码操作

### 1. 查询数据
```python
from database.db_manager import get_db_context
from database.models import ProductDB
from database.crud import ProductCRUD

# 方式1：直接使用 session
with get_db_context() as session:
    courses = session.query(ProductDB).filter(
        ProductDB.external_id.isnot(None)
    ).all()
    for course in courses:
        print(course.title_zh)

# 方式2：使用 CRUD
with get_db_context() as session:
    crud = ProductCRUD(session)
    products = crud.list_products()
```

### 2. 删除数据
```python
from database.db_manager import get_db_context
from database.models import ProductDB

# 删除所有课程数据
with get_db_context() as session:
    session.query(ProductDB).filter(
        ProductDB.external_id.isnot(None)
    ).delete()
    session.commit()
```

### 3. 清空表
```python
from database.db_manager import get_db_context
from database.models import ProductDB

with get_db_context() as session:
    session.query(ProductDB).delete()
    session.commit()
```

### 4. 重置数据库
```python
# 删除数据库文件，然后重新初始化
import os
os.remove('./cognimark.db')

from database.db_manager import init_db
init_db()
```

## 二、换数据操作流程

### 场景1：更新数据（保留结构）
```python
# 1. 删除旧数据
with get_db_context() as session:
    session.query(ProductDB).delete()
    session.commit()

# 2. 导入新数据
from services.import_service import import_from_file

result = import_from_file(
    file_path='新数据.xlsx',
    batch_name='新数据导入',
    skip_duplicates=False
)
```

### 场景2：完全替换
```bash
# 1. 备份当前数据库（可选）
cp cognimark.db cognimark.db.backup

# 2. 删除数据库
rm cognimark.db

# 3. 运行初始化
cd backend
python database/db_init.py

# 4. 导入新数据
python -c "
from services.import_service import import_from_file
import_from_file('新数据.xlsx')
"
```

## 三、可视化管理工具

### 推荐：DataGrip（JetBrains）

1. **打开数据库**
   - 方式1：拖拽 `cognimark.db` 到 DataGrip
   - 方式2：File → New → Data Source → SQLite
   - 文件路径：`E:\AI\smartcross_agent\ai_agent_demo\backend\cognimark.db`

2. **常用操作**
   - 查看数据：双击表名 → 点击 Data 标签
   - 查询：Console 标签 → 写 SQL
   - 修改数据：直接在表格中编辑
   - 删除数据：选中行 → 右键 Delete

### 备用方案

1. **DB Browser for SQLite**（免费）
   - 下载：https://sqlitebrowser.org/
   - 轻量级，适合简单操作

2. **VSCode 扩展**
   - SQLite Viewer
   - SQLite

## 四、常用 SQL 命令

```sql
-- 查看所有表
SELECT name FROM sqlite_master WHERE type='table';

-- 查看表结构
PRAGMA table_info(products);

-- 统计课程数量
SELECT COUNT(*) FROM products WHERE external_id IS NOT NULL;

-- 按类型统计
SELECT resource_type, COUNT(*) as count
FROM products
WHERE external_id IS NOT NULL
GROUP BY resource_type;

-- 搜索课程
SELECT * FROM products
WHERE title_zh LIKE '%Vue%'
LIMIT 10;

-- 删除所有课程数据
DELETE FROM products WHERE external_id IS NOT NULL;

-- 删除特定课程
DELETE FROM products WHERE external_id = '1025';
```

## 五、快速换数据脚本

创建文件 `backend/reload_data.py`:
```python
import os
import sys
sys.path.insert(0, '.')

def reload_data(excel_file_path):
    """重新加载数据库并导入新数据"""
    # 1. 删除旧数据库
    if os.path.exists('./cognimark.db'):
        os.remove('./cognimark.db')
        print("✓ 已删除旧数据库")

    # 2. 初始化数据库
    from database.db_manager import init_db
    init_db()
    print("✓ 数据库初始化完成")

    # 3. 导入新数据
    from services.import_service import import_from_file
    result = import_from_file(excel_file_path)
    print(f"✓ 导入完成：{result['success_count']}/{result['total_records']}")

if __name__ == '__main__':
    reload_data('飞书T汇总精简数据_排序版_数字索引.xlsx')
```

使用方法：
```bash
cd backend
python reload_data.py
```
